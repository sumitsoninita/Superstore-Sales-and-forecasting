<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A-1 FENCE - Mobile App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .mobile-screen-content::-webkit-scrollbar {
        width: 4px;
      }
      .mobile-screen-content::-webkit-scrollbar-track {
        background: transparent;
      }
      .mobile-screen-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 2px;
      }
      .mobile-screen-content::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2d3748;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
        bottom: 100px;
      }
      .tab-active {
        border-bottom-color: #dc2626;
        color: #dc2626;
      }
      /* Chatbot Styles */
      .chat-bubble-user {
        background-color: #dc2626;
        color: white;
        align-self: flex-end;
      }
      .chat-bubble-bot {
        background-color: #e5e7eb;
        color: #1f2937;
        align-self: flex-start;
      }
      .typing-indicator {
        align-self: flex-start;
        display: flex;
        align-items: center;
        padding: 10px 12px;
      }
      .typing-indicator span {
        height: 8px;
        width: 8px;
        margin: 0 2px;
        background-color: #9ca3af;
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      /* Loading Spinner */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #dc2626;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      .small-loader {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #dc2626;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4">
    <!-- Mobile phone frame -->
    <div
      class="relative mx-auto border-gray-800 bg-gray-800 border-[12px] rounded-[2.5rem] h-[88vh] w-full max-w-[360px] shadow-2xl"
    >
      <div
        class="w-[140px] h-[18px] bg-gray-800 top-0 rounded-b-[1rem] left-1/2 -translate-x-1/2 absolute"
      ></div>
      <div
        class="h-[46px] w-[3px] bg-gray-800 absolute -start-[15px] top-[124px] rounded-s-lg"
      ></div>
      <div
        class="h-[46px] w-[3px] bg-gray-800 absolute -start-[15px] top-[178px] rounded-s-lg"
      ></div>
      <div
        class="h-[64px] w-[3px] bg-gray-800 absolute -end-[15px] top-[142px] rounded-e-lg"
      ></div>
      <div
        class="rounded-[2rem] overflow-hidden w-full h-full bg-white flex flex-col"
      >
        <!-- App content will be rendered here -->
        <div
          id="app-container"
          class="h-full w-full flex-grow flex flex-col"
        ></div>
        <!-- Toast notification container -->
        <div id="toast-container" class="toast"></div>
      </div>
    </div>
    <script type="module">
      // --- Firebase SDK Imports ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        updateDoc,
        onSnapshot,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      // --- Firebase Initialization ---
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "a1-fence-app-dev";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {
              apiKey: "your-api-key",
              authDomain: "your-auth-domain",
              projectId: "your-project-id",
            };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      // --- Firestore Collection References ---
      const requestsLogRef = collection(
        db,
        `artifacts/${appId}/public/data/Requests_Log`
      );
      const eprEvaluationRef = collection(
        db,
        `artifacts/${appId}/public/data/EPR_Evaluation`
      );
      const dispatchLogRef = collection(
        db,
        `artifacts/${appId}/public/data/Dispatch_Log`
      );
      const faqDatabaseRef = collection(
        db,
        `artifacts/${appId}/public/data/FAQ_Database`
      );
      // --- MOCK DATA (For Demo Purposes) ---
      const MOCK_USERS = [
        {
          id: "end-user",
          username: "user",
          name: "End User",
          role: "External",
          password: "user123",
        },
        {
          id: "service-team",
          username: "service",
          name: "Service Team",
          role: "Internal",
          password: "service123",
        },
        {
          id: "epr-team",
          username: "epr",
          name: "EPR Team",
          role: "Internal",
          password: "epr123",
        },
        {
          id: "admin",
          username: "admin",
          name: "Admin",
          role: "Internal",
          password: "admin123",
        },
      ];
      const MOCK_FAQ = [
        {
          question: "How long does a typical repair take?",
          answer:
            "Most standard repairs are completed within 2-4 hours. More complex issues may require a follow-up visit.",
        },
        {
          question: "What is your service area?",
          answer:
            "We serve the greater Springfield, Shelbyville, and Capital City areas.",
        },
        {
          question: "Do you offer emergency services?",
          answer:
            "Yes, we offer 24/7 emergency services for urgent issues. Please call us directly at 555-FENCE-CO.",
        },
      ];
      // --- CENTRALIZED APP STATE ---
      const state = {
        currentUser: null,
        userId: null,
        currentPage: "login",
        currentComplaintId: null,
        currentTab: "complaints",
        chatHistory: [],
        complaintPhoto: null,
        isBotTyping: false,
        isLoading: true,
        isAiWorking: { refine: false, evaluate: false },
        requestsLog: [],
        eprEvaluations: [],
        dispatchLogs: [],
        faqDatabase: [],
        unsubscribeListeners: [],
        chartInstances: {}, // To hold chart objects
      };
      const appContainer = document.getElementById("app-container");
      const toastContainer = document.getElementById("toast-container");
      // --- UTILITY FUNCTIONS ---
      function showToast(msg) {
        toastContainer.textContent = msg;
        toastContainer.classList.add("show");
        setTimeout(() => {
          toastContainer.classList.remove("show");
        }, 3000);
      }
      // --- DATA SEEDING from CSV ---
      const csvData = `Product Type,Complaint Type,Issue Severity,Assigned To,Complaint Status,Service Validation Outcome,Dispatch Request Date,Received by EPR (Yes/No),Estimated Repair Cost,Cost Approved (Y/N),Repair Completed Date,Final
Dispatch Date,Resolution Summary,TAT (Turnaround Time)
Power Adapter,Physical Damage,Low,C. Mehta,Submitted,Needs Dispatch,2025-07-28,Yes,224.75,N,2025-07-31,2025-08-01,Replaced part and tested,7.0
Gate Motor Controller,Overheating,High,D. Verma,Dispatched,Remote Support Resolved,2025-07-27,No,,,2025-07-27,2025-07-27,Resolved via phone support,0
Energizer,Overheating,Low,C. Mehta,Under Repair,Remote Support Resolved,2025-07-26,No,,,2025-07-26,2025-07-26,Resolved via phone support,0
Energizer,Charging Fault,High,E. Patel,Validated,Remote Support Resolved,2025-07-25,No,,,2025-07-25,2025-07-25,Resolved via phone support,0
Gate Motor Controller,Software Glitch,Low,D. Verma,Validated,Remote Support Resolved,2025-07-24,No,,,2025-07-24,2025-07-24,Resolved via phone support,0
Energizer,Charging Fault,Medium,B. Roy,Dispatched,Remote Support Resolved,2025-07-23,No,,,2025-07-23,2025-07-23,Resolved via phone support,0
Power Adapter,Overheating,Medium,A. Sharma,Under Repair,Remote Support Resolved,2025-07-22,No,,,2025-07-22,2025-07-22,Resolved via phone support,0
Gate Motor Controller,Charging Fault,Low,B. Roy,Validated,Needs Dispatch,2025-07-19,Yes,254.61,N,2025-07-21,2025-07-22,Replaced part and tested,6.0
Gate Motor Controller,Charging Fault,Medium,B. Roy,Submitted,Needs Dispatch,2025-07-18,Yes,150.00,Y,2025-07-20,2025-07-21,Firmware updated,4.0
Power Adapter,No Power,High,A. Sharma,Resolved,Needs Dispatch,2025-07-15,Yes,50.00,Y,2025-07-16,2025-07-17,Replaced adapter,3.0`;
      function parseCSV(data) {
        const rows = data.trim().split("\n");
        const headers = rows
          .shift()
          .split(",")
          .map((h) => h.trim());
        return rows.map((row) => {
          const values = row.split(",");
          return headers.reduce((obj, header, i) => {
            obj[header.replace(/ \(.+\)/, "").replace(/ /g, "")] =
              values[i]?.trim() || "";
            return obj;
          }, {});
        });
      }
      async function seedDatabase() {
        const requestsSnapshot = await getDocs(requestsLogRef);
        if (requestsSnapshot.empty) {
          console.log("Seeding Requests_Log database from CSV...");
          const dummyData = parseCSV(csvData);
          const userNames = [
            "Rohan Das",
            "Priya Sharma",
            "Amit Kumar",
            "Sunita Devi",
            "Vikram Singh",
            "Anjali Gupta",
            "Rajesh Patel",
            "Meena Kumari",
            "Sanjay Verma",
            "Pooja Reddy",
          ];
          const contacts = [
            "9876543210",
            "9876543211",
            "9876543212",
            "9876543213",
            "9876543214",
            "9876543215",
            "9876543216",
            "9876543217",
            "9876543218",
            "9876543219",
          ];
          const addresses = [
            "123 Main St, Agartala",
            "456 Park Ave, Agartala",
            "789 Lake Rd, Agartala",
            "101 Hilltop Dr, Agartala",
            "212 River Ln, Agartala",
            "333 Forest Gln, Agartala",
            "444 Mountain Vw, Agartala",
            "555 Ocean Blvd, Agartala",
            "666 Valley",
            "Rd",
            "Agartala",
            "777 Sunset Strip, Agartala",
          ];
          for (let i = 0; i < dummyData.length; i++) {
            const item = dummyData[i];
            const newComplaint = {
              creatorId: `user-id-${i}`,
              userName: userNames[i],
              contact: contacts[i],
              address: addresses[i],
              issue: item.ComplaintType,
              status: item.ComplaintStatus,
              date:
                item.DispatchRequestDate ||
                new Date().toISOString().split("T")[0],
              productType: item.ProductType,
              issueSeverity: item.IssueSeverity,
              assignedTo: item.AssignedTo,
              serviceValidationOutcome: item.ServiceValidationOutcome,
              receivedByEPR: item.ReceivedbyEPR,
              estimatedRepairCost: item.EstimatedRepairCost,
              costApproved: item.CostApproved,
              repairCompletedDate: item.RepairCompletedDate,
              finalDispatchDate: item.FinalDispatchDate,
              resolutionSummary: item.ResolutionSummary,
              turnaroundTime: item.TAT,
              photo: null,
            };
            await addDoc(requestsLogRef, newComplaint);
          }
        }
        const faqSnapshot = await getDocs(faqDatabaseRef);
        if (faqSnapshot.empty) {
          console.log("Seeding FAQ database...");
          for (const item of MOCK_FAQ) {
            await addDoc(faqDatabaseRef, item);
          }
        }
      }
      // --- RENDER ENGINE ---
      function render() {
        let template = "";
        if (state.isLoading && state.currentPage !== "login") {
          template = `<div class="flex-grow flex items-center justify-center"><div class="loader"></div></div>`;
        } else {
          switch (state.currentPage) {
            case "login":
              template = getLoginTemplate();
              break;
            case "forgotPassword":
              template = getForgotPasswordTemplate();
              break;
            case "main":
              template = getMainTemplate();
              break;
            case "complaintDetail":
              template = getComplaintDetailTemplate();
              break;
            case "newComplaintForm":
              template = getNewComplaintFormTemplate();
              break;
            default:
              template = `<div class="p-4">Page not found</div>`;
          }
        }
        appContainer.innerHTML = template;
        if (state.currentPage === "main" && state.currentTab === "dashboard") {
          renderDashboardCharts();
        }
        const chatWindow = document.getElementById("chat-window");
        if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
      }
      // --- TEMPLATE GENERATORS ---
      function getLoginTemplate() {
        return `
<div class="flex-grow flex flex-col items-center justify-center bg-white p-6 fade-in">
<div class="text-center mb-8">
<h1 class="text-6xl font-extrabold text-gray-900 tracking-tighter">A1</h1>
<p class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-red-800 tracking-wide">FENCE SERVICES</p>
</div>
<h1 class="text-2xl font-bold mb-2 text-gray-900">Welcome Back</h1>
<p class="text-gray-600 mb-8">Sign in to your account</p>
<form id="login-form" class="w-full">
<div class="w-full space-y-4">
<div>
<label for="username-input" class="block text-sm font-medium text-gray-700">User ID</label>
<input type="text" id="username-input" class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
</div>
<div>
<label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
<input type="password" id="password-input" class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
</div>
</div>
<div class="flex items-center justify-end w-full mt-4">
<button type="button" id="forgot-password-link" class="text-sm text-red-600 hover:underline">Forgot password?</button>
</div>
<button type="submit" id="login-btn" class="mt-6 w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform
hover:scale-105">Login</button>
</form>
</div>
`;
      }
      function getForgotPasswordTemplate() {
        return `
<div class="flex flex-col h-full">
<header class="flex items-center gap-4 p-4 bg-gray-50 border-b border-gray-200">
<button id="back-to-login-btn" class="text-gray-600 hover:text-red-600">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
</button>
<h1 class="font-bold text-lg text-gray-800">Forgot Password</h1>
</header>
<main class="flex-grow p-6 text-center flex flex-col items-center justify-center">
<h2 class="text-lg font-semibold text-gray-800">Password Reset</h2>
<p class="text-gray-600 mt-2">For security reasons, please contact system administration to reset your password.</p>
<p class="mt-4 text-sm text-gray-800 font-medium">Support: <a href="mailto:support@a1fence.com" class="text-red-600 hover:underline">support@a1fence.com</a></p>
</main>
</div>
`;
      }
      function getMainTemplate() {
        const tabs = {
          admin: ["Complaints", "Dispatch", "Evaluation", "Dashboard"],
          "epr-team": ["Complaints", "Evaluation", "Dashboard"],
          "service-team": ["Complaints", "Dispatch", "Dashboard"],
          "end-user": ["My Complaints", "Chatbot", "Help Center"],
        };
        const availableTabs = tabs[state.currentUser.id] || [];
        return `
<div class="flex flex-col h-full fade-in">
<header class="flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200">
<div>
<h1 class="font-bold text-lg text-gray-800">A-1 Fence</h1>
<p class="text-sm text-gray-500">Welcome, ${state.currentUser.name}</p>
</div>
<button id="logout-btn" class="text-sm text-red-600 hover:underline">Logout</button>
</header>
<nav class="flex border-b border-gray-200 bg-white">
${availableTabs
  .map(
    (tab) => `
<button data-tab="${tab
      .toLowerCase()
      .replace(
        " ",
        "-"
      )}" class="nav-tab flex-1 py-3 px-2 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 ${
      state.currentTab === tab.toLowerCase().replace(" ", "-")
        ? "tab-active"
        : ""
    }">
${tab}
</button>
`
  )
  .join("")}
</nav>
<main id="tab-content" class="flex-grow bg-gray-100 mobile-screen-content overflow-y-auto flex flex-col">
${getTabContent()}
</main>
</div>
`;
      }
      function getTabContent() {
        switch (state.currentTab) {
          case "complaints":
          case "my-complaints":
            return `<div class="p-4">${getComplaintsListContent()}</div>`;
          case "dispatch":
            return `<div class="p-4">${getDispatchLogContent()}</div>`;
          case "evaluation":
            return `<div class="p-4">${getEPREvaluationContent()}</div>`;
          case "help-center":
            return `<div class="p-4">${getHelpCenterContent()}</div>`;
          case "dashboard":
            return getDashboardContent();
          case "chatbot":
            return getChatbotContent();
          default:
            return `<p class="p-4">Select a tab</p>`;
        }
      }
      function getStatusBadge(status) {
        const colors = {
          Submitted: "bg-yellow-100 text-yellow-800",
          Pending: "bg-yellow-100 text-yellow-800",
          "In Progress": "bg-blue-100 text-blue-800",
          "Under Repair": "bg-blue-100 text-blue-800",
          Resolved: "bg-green-100 text-green-800",
          Dispatched: "bg-purple-100 text-purple-800",
          Validated: "bg-indigo-100 text-indigo-800",
        };
        return `<span class="px-2 py-1 text-xs font-medium rounded-full ${
          colors[status] || "bg-gray-100 text-gray-800"
        }">${status}</span>`;
      }
      function getComplaintsListContent() {
        const canAddNew = state.currentUser.id === "end-user";
        const canQuickUpdate = ["admin", "service-team"].includes(
          state.currentUser.id
        );
        let complaintsToDisplay = [...state.requestsLog];
        if (state.currentUser.id === "end-user") {
          complaintsToDisplay = complaintsToDisplay.filter(
            (r) => r.creatorId === state.userId
          );
        } else if (
          state.currentUser.id === "service-team" ||
          state.currentUser.id === "epr-team"
        ) {
          complaintsToDisplay = complaintsToDisplay.filter(
            (r) => r.status !== "Resolved"
          );
        }
        complaintsToDisplay.sort((a, b) => new Date(b.date) - new Date(a.date));
        return `
<div class="p-4 space-y-4">
${
  canAddNew
    ? `
<div class="space-y-3">
<a href="tel:555-336-2326" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform
hover:scale-105">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
<path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
</svg>
<span>Talk to Service</span>
</a>
<button id="add-new-complaint-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform
transform hover:scale-105">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
clip-rule="evenodd" /></svg>
<span>File a New Complaint</span>
</button>
</div>
`
    : ""
}
${
  complaintsToDisplay.length > 0
    ? complaintsToDisplay
        .map(
          (c) => `
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
<div class="view-complaint-btn cursor-pointer" data-id="${c.id}">
<div class="flex justify-between items-start">
<p class="font-bold text-gray-800">${c.productType}</p>
${getStatusBadge(c.status)}
</div>
<p class="text-sm text-gray-600 mt-2">Issue: ${c.issue}</p>
<p class="text-xs text-gray-400 mt-3">By: ${c.userName} on ${c.date}</p>
</div>
${
  canQuickUpdate
    ? `
<div class="mt-3 pt-3 border-t">
<label class="text-xs font-medium text-gray-500">Quick Update Status:</label>
<select data-id="${
        c.id
      }" class="list-status-updater mt-1 w-full p-1.5 text-xs rounded-md border-gray-300 focus:ring-red-500 focus:border-red-500 bg-gray-50">
${["Submitted", "Validated", "Under Repair", "Dispatched", "Resolved"]
  .map(
    (s) =>
      `<option value="${s}" ${c.status === s ? "selected" : ""}>${s}</option>`
  )
  .join("")}
</select>
</div>
`
    : ""
}
</div>
`
        )
        .join("")
    : '<p class="text-center text-gray-500 mt-8">No complaints found.</p>'
}
</div>
`;
      }
      function getComplaintDetailTemplate() {
        const complaint = state.requestsLog.find(
          (c) => c.id === state.currentComplaintId
        );
        if (!complaint) return `<p>Complaint not found.</p>`;
        const evaluation = state.eprEvaluations.find(
          (e) => e.requestId === complaint.id
        );
        const canUpdate = ["admin", "service-team"].includes(
          state.currentUser.id
        );
        const canEvaluate =
          ["admin", "epr-team"].includes(state.currentUser.id) && !evaluation;
        return `
<div class="flex flex-col h-full">
<header class="flex items-center gap-4 p-4 bg-gray-50 border-b border-gray-200">
<button id="back-to-main-btn" class="text-gray-600 hover:text-red-600">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
</button>
<h1 class="font-bold text-lg text-gray-800">Complaint #${complaint.id
          .substring(0, 6)
          .toUpperCase()}</h1>
</header>
<main class="flex-grow p-4 mobile-screen-content overflow-y-auto bg-white space-y-6">
<!-- Complaint Details -->
<div>
<div class="flex justify-between items-center">
<h2 class="font-semibold text-gray-700">Complaint Details</h2>
${getStatusBadge(complaint.status)}
</div>
<div class="mt-2 text-sm text-gray-600 space-y-2 bg-gray-50 p-3 rounded-lg border">
<p><strong class="font-medium text-gray-800">Product:</strong> ${
          complaint.productType
        }</p>
<p><strong class="font-medium text-gray-800">Complaint:</strong> ${
          complaint.issue
        }</p>
<p><strong class="font-medium text-gray-800">Severity:</strong> ${
          complaint.issueSeverity
        }</p>
<p><strong class="font-medium text-gray-800">Assigned To:</strong> ${
          complaint.assignedTo
        }</p>
<p><strong class="font-medium text-gray-800">Request Date:</strong> ${
          complaint.date
        }</p>
</div>
</div>
<!-- User Info -->
<div>
<h2 class="font-semibold text-gray-700">User Information</h2>
<div class="mt-2 text-sm text-gray-600 space-y-2 bg-gray-50 p-3 rounded-lg border">
<p><strong class="font-medium text-gray-800">Name:</strong> ${
          complaint.userName
        }</p>
<p><strong class="font-medium text-gray-800">Contact:</strong> ${
          complaint.contact
        }</p>
<p><strong class="font-medium text-gray-800">Address:</strong> ${
          complaint.address
        }</p>
</div>
</div>
<!-- Repair & Resolution -->
<div>
<h2 class="font-semibold text-gray-700">Repair & Resolution</h2>
<div class="mt-2 text-sm text-gray-600 space-y-2 bg-gray-50 p-3 rounded-lg border">
<p><strong class="font-medium text-gray-800">Resolution:</strong> ${
          complaint.resolutionSummary || "N/A"
        }</p>
<p><strong class="font-medium text-gray-800">Repair Completed:</strong> ${
          complaint.repairCompletedDate || "N/A"
        }</p>
<p><strong class="font-medium text-gray-800">Final Dispatch:</strong> ${
          complaint.finalDispatchDate || "N/A"
        }</p>
<p><strong class="font-medium text-gray-800">Turnaround Time:</strong> ${
          complaint.turnaroundTime ? `${complaint.turnaroundTime} days` : "N/A"
        }</p>
</div>
</div>
<!-- Cost -->
<div>
<h2 class="font-semibold text-gray-700">Costing</h2>
<div class="mt-2 text-sm text-gray-600 space-y-2 bg-gray-50 p-3 rounded-lg border">
<p><strong class="font-medium text-gray-800">Estimated Cost:</strong> ${
          complaint.estimatedRepairCost
            ? `₹${complaint.estimatedRepairCost}`
            : "N/A"
        }</p>
<p><strong class="font-medium text-gray-800">Cost Approved:</strong> ${
          complaint.costApproved || "N/A"
        }</p>
</div>
</div>
${
  complaint.photo
    ? `
<div>
<h2 class="font-semibold text-gray-700">Attached Photo</h2>
<img src="${complaint.photo}" alt="Complaint photo" class="mt-2 rounded-lg border border-gray-200 w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
</div>
`
    : ""
}
${
  state.currentUser.id !== "end-user"
    ? `
<div class="space-y-4 pt-4">
${
  canEvaluate
    ? `
<div id="ai-evaluation-container">
<button id="generate-evaluation-btn" data-id="${
        complaint.id
      }" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
${
  state.isAiWorking.evaluate
    ? '<div class="loader small-loader"></div><span>Generating...</span>'
    : "✨ Generate AI Evaluation"
}
</button>
</div>
`
    : ""
}
${
  evaluation
    ? `
<div>
<h2 class="font-semibold text-gray-700">EPR Evaluation</h2>
<div class="mt-2 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200">
<p><strong class="font-medium text-gray-800">Notes:</strong> ${evaluation.notes}</p>
<p class="mt-1"><strong class="font-medium text-gray-800">Recommendation:</strong> ${evaluation.recommendation}</p>
</div>
</div>`
    : ""
}
</div>
`
    : ""
}
${
  canUpdate
    ? `
<div class="pt-4">
<h2 class="font-semibold text-gray-700 mb-2">Update Status</h2>
<select id="status-updater" data-id="${
        complaint.id
      }" class="px-4 py-2 rounded-lg border border-gray-300 w-full bg-gray-50 focus:outline-none focus:ring-2 focus:ring-red-500">
${["Submitted", "Validated", "Under Repair", "Dispatched", "Resolved"]
  .map(
    (s) =>
      `<option value="${s}" ${
        complaint.status === s ? "selected" : ""
      }>${s}</option>`
  )
  .join("")}
</select>
</div>
`
    : ""
}
</main>
</div>
`;
      }
      function getNewComplaintFormTemplate() {
        return `
<div class="flex flex-col h-full">
<header class="flex items-center gap-4 p-4 bg-gray-50 border-b border-gray-200">
<button id="back-to-main-btn" class="text-gray-600 hover:text-red-600">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
</button>
<h1 class="font-bold text-lg text-gray-800">New Complaint</h1>
</header>
<main class="flex-grow p-4 mobile-screen-content overflow-y-auto bg-white">
<form id="new-complaint-form" class="space-y-4">
<div>
<label for="userName" class="block text-sm font-medium text-gray-700">Full Name</label>
<input type="text" id="userName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
</div>
<div>
<label for="contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
<input type="tel" id="contact" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
</div>
<div>
<label for="address" class="block text-sm font-medium text-gray-700">Service Address</label>
<input type="text" id="address" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
</div>
<div>
<div class="flex justify-between items-center">
<label for="issue" class="block text-sm font-medium text-gray-700">Describe the Issue</label>
<button type="button" id="refine-issue-btn" class="text-xs text-blue-600 hover:underline" ${
          state.isAiWorking.refine ? "disabled" : ""
        }>
${state.isAiWorking.refine ? "Refining..." : "✨ Refine with AI"}
</button>
</div>
<textarea id="issue" rows="4" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Attach a Photo (Optional)</label>
<div class="mt-1">
<img id="photo-preview" class="hidden w-full h-auto rounded-lg border border-gray-200 mb-2" src="" alt="Photo preview">
<input type="file" id="photo-upload" class="hidden" accept="image/*">
<label for="photo-upload" class="cursor-pointer w-full flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 border border-gray-300">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
clip-rule="evenodd" /></svg>
<span>Upload a Photo</span>
</label>
</div>
</div>
<button type="submit" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Submit Complaint</button>
</form>
</main>
</div>
`;
      }
      function getDispatchLogContent() {
        const sortedLogs = [...state.dispatchLogs].sort(
          (a, b) => new Date(b.dispatchDate) - new Date(a.dispatchDate)
        );
        return `
<div class="p-4 space-y-4">
<h2 class="text-lg font-bold text-gray-800">Dispatch Log</h2>
${
  sortedLogs.length > 0
    ? sortedLogs
        .map(
          (d) => `
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
<p class="font-bold text-gray-800">Request #${
            state.requestsLog
              .find((r) => r.id === d.requestId)
              ?.id.substring(0, 6)
              .toUpperCase() || "N/A"
          }</p>
<p class="text-sm text-gray-600 mt-2">Team: ${d.teamName}</p>
<p class="text-sm text-gray-600 mt-1">Status: <span class="font-medium">${
            d.status
          }</span></p>
<p class="text-xs text-gray-400 mt-3">Dispatched on: ${d.dispatchDate}</p>
</div>
`
        )
        .join("")
    : '<p class="text-center text-gray-500 mt-8">No dispatch logs found.</p>'
}
</div>
`;
      }
      function getEPREvaluationContent() {
        const sortedEvals = [...state.eprEvaluations].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );
        return `
<div class="p-4 space-y-4">
<h2 class="text-lg font-bold text-gray-800">EPR Evaluations</h2>
${
  sortedEvals.length > 0
    ? sortedEvals
        .map(
          (e) => `
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
<p class="font-bold text-gray-800">Request #${
            state.requestsLog
              .find((r) => r.id === e.requestId)
              ?.id.substring(0, 6)
              .toUpperCase() || "N/A"
          }</p>
<p class="text-sm text-gray-600 mt-2">Notes: ${e.notes}</p>
<p class="text-sm text-gray-600 mt-1">Recommendation: <span class="font-medium">${
            e.recommendation
          }</span></p>
<p class="text-xs text-gray-400 mt-3">Evaluated by: ${e.evaluator} on ${
            e.date
          }</p>
</div>
`
        )
        .join("")
    : '<p class="text-center text-gray-500 mt-8">No evaluations found.</p>'
}
</div>
`;
      }
      function getHelpCenterContent() {
        return `
<div class="p-4 space-y-6">
<div>
<h2 class="text-lg font-bold text-gray-800 mb-4">Frequently Asked Questions</h2>
<div class="space-y-4">
${
  state.faqDatabase.length > 0
    ? state.faqDatabase
        .map(
          (f) => `
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
<p class="font-semibold text-gray-800">${f.question}</p>
<p class="text-sm text-gray-600 mt-2">${f.answer}</p>
</div>
`
        )
        .join("")
    : '<p class="text-center text-gray-500 mt-8">No FAQs available.</p>'
}
</div>
</div>
<div>
<h2 class="text-lg font-bold text-gray-800 mb-4">Contact Us</h2>
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
<p class="font-semibold text-gray-800">Need more help?</p>
<p class="text-sm text-gray-600 mt-2">Our team is here to assist you. For urgent matters, please call us directly.</p>
<p class="mt-3 text-sm text-gray-800 font-medium">Phone: <a href="tel:555-336-2326" class="text-red-600 hover:underline">555-FENCE-CO</a></p>
<p class="mt-3 text-sm text-gray-800 font-medium">Email: <a href="mailto:support@a1fence.com" class="text-red-600 hover:underline">support@a1fence.com</a></p>
</div>
</div>
</div>
`;
      }
      function getDashboardContent() {
        const totalComplaints = state.requestsLog.length;
        const pendingComplaints = state.requestsLog.filter((r) =>
          ["Pending", "Submitted", "Validated"].includes(r.status)
        ).length;
        const today = new Date().toISOString().split("T")[0];
        const resolvedToday = state.requestsLog.filter(
          (r) => r.status === "Resolved" && r.finalDispatchDate === today
        ).length;
        return `
<div class="p-4 space-y-6">
<h2 class="text-xl font-bold text-gray-800">Analytics Dashboard</h2>
<!-- Stat Cards -->
<div class="grid grid-cols-3 gap-4 text-center">
<div class="bg-white p-4 rounded-lg shadow-sm">
<p class="text-2xl font-bold text-gray-800">${totalComplaints}</p>
<p class="text-xs text-gray-500">Total Complaints</p>
</div>
<div class="bg-white p-4 rounded-lg shadow-sm">
<p class="text-2xl font-bold text-yellow-500">${pendingComplaints}</p>
<p class="text-xs text-gray-500">Pending</p>
</div>
<div class="bg-white p-4 rounded-lg shadow-sm">
<p class="text-2xl font-bold text-green-500">${resolvedToday}</p>
<p class="text-xs text-gray-500">Resolved Today</p>
</div>
</div>
<!-- Charts -->
<div class="bg-white p-4 rounded-lg shadow-sm">
<h3 class="font-semibold text-gray-700 mb-2">Complaints by Product</h3>
<canvas id="complaintsByProductChart"></canvas>
</div>
<div class="bg-white p-4 rounded-lg shadow-sm">
<h3 class="font-semibold text-gray-700 mb-2">Complaint Status</h3>
<canvas id="complaintStatusChart"></canvas>
</div>
<div class="bg-white p-4 rounded-lg shadow-sm">
<h3 class="font-semibold text-gray-700 mb-2">Recent Activity (Last 30 Days)</h3>
<canvas id="complaintsOverTimeChart"></canvas>
</div>
</div>
`;
      }
      function getChatbotContent() {
        if (state.chatHistory.length === 0) {
          state.chatHistory.push({
            sender: "bot",
            text: "Hello! I am FenceBot, the A-1 Fence assistant. How can I help you today?",
          });
        }
        return `
<div id="chat-window" class="flex-grow p-4 space-y-4 flex flex-col overflow-y-auto">
${state.chatHistory
  .map(
    (msg) => `
<div class="max-w-[80%] rounded-xl px-4 py-2 text-sm ${
      msg.sender === "user" ? "chat-bubble-user" : "chat-bubble-bot"
    }">
${msg.text}
</div>
`
  )
  .join("")}
${
  state.isBotTyping
    ? `
<div class="chat-bubble-bot typing-indicator">
<span></span><span></span><span></span>
</div>
`
    : ""
}
</div>
<form id="chatbot-form" class="p-4 bg-white border-t border-gray-200 flex items-center gap-2">
<input type="text" id="chatbot-input" placeholder="Type your message..." class="flex-grow px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500" autocomplete="off">
<button type="submit" class="bg-red-600 text-white rounded-full p-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5
1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
</button>
</form>
`;
      }
      // --- DASHBOARD CHART RENDERING ---
      function destroyCharts() {
        Object.values(state.chartInstances).forEach((chart) => chart.destroy());
        state.chartInstances = {};
      }
      function renderDashboardCharts() {
        destroyCharts(); // Clear previous charts
        // Data for Status Doughnut Chart
        const statusCounts = state.requestsLog.reduce((acc, r) => {
          acc[r.status] = (acc[r.status] || 0) + 1;
          return acc;
        }, {});
        const statusCtx = document
          .getElementById("complaintStatusChart")
          ?.getContext("2d");
        if (statusCtx) {
          state.chartInstances.statusChart = new Chart(statusCtx, {
            type: "doughnut",
            data: {
              labels: Object.keys(statusCounts),
              datasets: [
                {
                  data: Object.values(statusCounts),
                  backgroundColor: [
                    "#FBBF24",
                    "#60A5FA",
                    "#34D399",
                    "#A78BFA",
                    "#7DD3FC",
                  ],
                  borderColor: "#ffffff",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "bottom" } },
            },
          });
        }
        // Data for Complaints by Product Bar Chart
        const productCounts = state.requestsLog.reduce((acc, r) => {
          acc[r.productType] = (acc[r.productType] || 0) + 1;
          return acc;
        }, {});
        const productCtx = document
          .getElementById("complaintsByProductChart")
          ?.getContext("2d");
        if (productCtx) {
          state.chartInstances.productChart = new Chart(productCtx, {
            type: "bar",
            data: {
              labels: Object.keys(productCounts),
              datasets: [
                {
                  label: "No. of Complaints",
                  data: Object.values(productCounts),
                  backgroundColor: "rgba(220, 38, 38, 0.6)",
                  borderColor: "rgba(220, 38, 38, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              responsive: true,
              plugins: { legend: { display: false } },
            },
          });
        }
        // Data for Complaints Over Time Line Chart
        const complaintsByDate = {};
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        for (let i = 0; i < 30; i++) {
          const date = new Date(thirtyDaysAgo);
          date.setDate(date.getDate() + i);
          const dateString = date.toISOString().split("T")[0];
          complaintsByDate[dateString] = 0;
        }
        state.requestsLog.forEach((req) => {
          if (new Date(req.date) >= thirtyDaysAgo) {
            if (complaintsByDate[req.date] !== undefined) {
              complaintsByDate[req.date]++;
            }
          }
        });
        const timeCtx = document
          .getElementById("complaintsOverTimeChart")
          ?.getContext("2d");
        if (timeCtx) {
          state.chartInstances.timeChart = new Chart(timeCtx, {
            type: "line",
            data: {
              labels: Object.keys(complaintsByDate).map((d) =>
                new Date(d).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Complaints",
                  data: Object.values(complaintsByDate),
                  borderColor: "#EF4444",
                  backgroundColor: "rgba(239, 68, 68, 0.1)",
                  fill: true,
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
            },
          });
        }
      }
      // --- GEMINI API HELPERS ---
      async function callGeminiAPI(payload) {
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        try {
          for (let i = 0; i < 5; i++) {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (response.ok) {
              const result = await response.json();
              if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
              }
            }
            if (response.status === 429 || response.status >= 500) {
              const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
              await new Promise((resolve) => setTimeout(resolve, delay));
            } else {
              throw new Error(
                `API Error: ${response.status} ${await response.text()}`
              );
            }
          }
          throw new Error("API request failed after multiple retries.");
        } catch (error) {
          console.error("Gemini API Call Error:", error);
          return null;
        }
      }
      async function getRefinedDescription(originalText) {
        const prompt = `You are a helpful assistant. A customer is writing a complaint about their fence. Rewrite the following description to be clearer, more professional, and well-structured for a service team to easily understand. Retain all key details
provided by the user. Original description: "${originalText}"`;
        const payload = {
          contents: [{ role: "user", parts: [{ text: prompt }] }],
        };
        return await callGeminiAPI(payload);
      }
      async function getAIEvaluation(complaint) {
        const { issue, userName, address, photo, productType, issueSeverity } =
          complaint;
        const promptParts = [
          {
            text: `You are an expert fence repair evaluator for A-1 Fence. It is currently ${new Date().toLocaleString(
              "en-US",
              { timeZone: "Asia/Kolkata" }
            )} in Agartala, Tripura, India. Analyze the following complaint to generate a concise evaluation. Your
response MUST be a valid JSON object with two string keys: "notes" and "recommendation". The 'notes' should summarize the issue. The 'recommendation' must be one of these three options: 'Dispatch Team', 'Request More Information', or 'Close Ticket'.
Complaint Details:\n- User: ${userName}\n- Address: ${address}\n- Product: ${productType}\n- Severity: ${issueSeverity}\n- Issue: ${issue}`,
          },
        ];
        if (photo) {
          promptParts.push({ text: "\n- An image is attached for analysis." });
          promptParts.push({
            inlineData: { mimeType: "image/jpeg", data: photo.split(",")[1] },
          });
        }
        const payload = {
          contents: [{ role: "user", parts: promptParts }],
          generationConfig: { responseMimeType: "application/json" },
        };
        const resultText = await callGeminiAPI(payload);
        try {
          return JSON.parse(resultText);
        } catch (e) {
          console.error("Failed to parse AI evaluation JSON:", e);
          return null;
        }
      }
      async function getGeminiBotResponse(userInput) {
        const userComplaints = state.requestsLog
          .filter((r) => r.creatorId === state.userId)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
        const latestComplaint =
          userComplaints.length > 0
            ? userComplaints[0]
            : "No complaints found for this user.";
        const prompt = `You are FenceBot, a friendly virtual assistant for A-1 Fence. You are talking to ${
          state.currentUser.name
        }. Today's date is ${new Date().toDateString()}. Your goal is to answer user questions about their fence complaints, our
services, and company information. Context:\n- FAQ: ${JSON.stringify(
          state.faqDatabase
        )}\n- User's most recent complaint: ${JSON.stringify(
          latestComplaint
        )}\n\nInstructions:\n- Keep answers concise and friendly.\n- If asked to file a complaint, direct them
to the "File a New Complaint" button in the "My Complaints" tab.\n- If you don't know, politely say so and suggest the "Help Center" or calling support.\n\nUser's question: "${userInput}"`;
        const payload = {
          contents: [{ role: "user", parts: [{ text: prompt }] }],
        };
        const response = await callGeminiAPI(payload);
        return (
          response ||
          "I'm having a little trouble connecting right now. Please try again in a moment."
        );
      }
      // --- FIRESTORE DATA LISTENERS ---
      function attachFirestoreListeners() {
        detachFirestoreListeners();
        state.isLoading = true;
        render();
        const unsubFunctions = [
          onSnapshot(requestsLogRef, (snapshot) => {
            state.requestsLog = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            state.isLoading = false;
            render();
          }),
          onSnapshot(eprEvaluationRef, (snapshot) => {
            state.eprEvaluations = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          }),
          onSnapshot(dispatchLogRef, (snapshot) => {
            state.dispatchLogs = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          }),
          onSnapshot(faqDatabaseRef, (snapshot) => {
            state.faqDatabase = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          }),
        ];
        state.unsubscribeListeners.push(...unsubFunctions);
      }
      function detachFirestoreListeners() {
        destroyCharts();
        state.unsubscribeListeners.forEach((unsub) => unsub());
        state.unsubscribeListeners = [];
      }
      // --- EVENT HANDLERS (using Event Delegation) ---
      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (form.id === "login-form") {
          const user = MOCK_USERS.find(
            (u) =>
              u.username ===
                form.querySelector("#username-input").value.trim() &&
              u.password === form.querySelector("#password-input").value
          );
          if (user) {
            state.currentUser = user;
            state.currentTab =
              user.role === "External" ? "my-complaints" : "complaints";
            state.chatHistory = [];
            state.currentPage = "main";
            attachFirestoreListeners();
          } else {
            showToast("Invalid credentials. Please try again.");
          }
        }
        if (form.id === "new-complaint-form") {
          const newComplaint = {
            creatorId: state.userId,
            userName: form.querySelector("#userName").value,
            contact: form.querySelector("#contact").value,
            address: form.querySelector("#address").value,
            issue: form.querySelector("#issue").value,
            status: "Submitted",
            date: new Date().toISOString().split("T")[0],
            productType: "Unknown",
            issueSeverity: "Medium",
            assignedTo: "A. Sharma",
            photo: state.complaintPhoto,
          };
          try {
            await addDoc(requestsLogRef, newComplaint);
            state.currentPage = "main";
            state.currentTab = "my-complaints";
            showToast("Complaint submitted successfully!");
          } catch (error) {
            console.error("Error adding document: ", error);
            showToast("Failed to submit complaint.");
          }
        }
        if (form.id === "chatbot-form") {
          const inputField = form.querySelector("#chatbot-input");
          const userInput = inputField.value.trim();
          if (userInput && !state.isBotTyping) {
            state.chatHistory.push({ sender: "user", text: userInput });
            state.isBotTyping = true;
            inputField.value = "";
            render();
            const botResponse = await getGeminiBotResponse(userInput);
            state.isBotTyping = false;
            state.chatHistory.push({ sender: "bot", text: botResponse });
            render();
          }
        }
      }
      async function handleClick(e) {
        // Prevent click action if the target is the quick status updater
        if (e.target.closest(".list-status-updater")) {
          return;
        }
        const button = e.target.closest("button");
        const complaintCard = e.target.closest(".view-complaint-btn");
        if (button) {
          // AI Features
          if (button.id === "refine-issue-btn") {
            const issueTextarea = document.getElementById("issue");
            if (!issueTextarea.value) {
              showToast("Please enter a description first.");
              return;
            }
            state.isAiWorking.refine = true;
            render();
            const refinedText = await getRefinedDescription(
              issueTextarea.value
            );
            if (refinedText) {
              issueTextarea.value = refinedText;
            } else {
              showToast("AI refinement failed. Please try again.");
            }
            state.isAiWorking.refine = false;
            render();
          }
          if (button.id === "generate-evaluation-btn") {
            const complaintId = button.dataset.id;
            const complaint = state.requestsLog.find(
              (c) => c.id === complaintId
            );
            if (!complaint) return;
            state.isAiWorking.evaluate = true;
            render();
            const evaluationResult = await getAIEvaluation(complaint);
            if (evaluationResult) {
              const newEvaluation = {
                requestId: complaintId,
                evaluator: `AI Assistant (${state.currentUser.name})`,
                date: new Date().toISOString().split("T")[0],
                ...evaluationResult,
              };
              await addDoc(eprEvaluationRef, newEvaluation);
              showToast("AI evaluation generated successfully!");
            } else {
              showToast("AI evaluation failed. Please try again.");
            }
            state.isAiWorking.evaluate = false;
          }
          // Navigation & Actions
          if (button.id === "forgot-password-link") {
            state.currentPage = "forgotPassword";
            render();
          }
          if (button.id === "back-to-login-btn") {
            state.currentPage = "login";
            render();
          }
          if (button.id === "logout-btn") {
            state.currentUser = null;
            state.currentPage = "login";
            detachFirestoreListeners();
            render();
          }
          if (button.closest(".nav-tab")) {
            destroyCharts();
            state.currentTab = button.dataset.tab;
            render();
          }
          if (button.id === "add-new-complaint-btn") {
            state.currentPage = "newComplaintForm";
            state.complaintPhoto = null;
            render();
          }
          if (button.id === "back-to-main-btn") {
            state.currentPage = "main";
            state.currentComplaintId = null;
            render();
          }
        }
        if (complaintCard) {
          state.currentComplaintId = complaintCard.dataset.id;
          state.currentPage = "complaintDetail";
          render();
        }
      }
      async function handleChange(e) {
        const target = e.target;
        if (
          target.id === "status-updater" ||
          target.classList.contains("list-status-updater")
        ) {
          const complaintDocRef = doc(
            db,
            `artifacts/${appId}/public/data/Requests_Log`,
            target.dataset.id
          );
          try {
            await updateDoc(complaintDocRef, { status: target.value });
            showToast(`Status updated to ${target.value}`);
          } catch (error) {
            console.error("Error updating status: ", error);
            showToast("Failed to update status.");
          }
        }
        if (target.id === "photo-upload") {
          const file = target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              state.complaintPhoto = event.target.result;
              const photoPreview = document.getElementById("photo-preview");
              if (photoPreview) {
                photoPreview.src = state.complaintPhoto;
                photoPreview.classList.remove("hidden");
              }
            };
            reader.readAsDataURL(file);
          }
        }
      }
      // --- INITIALIZATION ---
      async function initialize() {
        appContainer.addEventListener("submit", handleFormSubmit);
        appContainer.addEventListener("click", handleClick);
        appContainer.addEventListener("change", handleChange);
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          state.isLoading = false;
          render();
        }
        onAuthStateChanged(auth, (user) => {
          if (user) {
            state.userId = user.uid;
            console.log("Authenticated user with UID:", state.userId);
            seedDatabase(); // This will now seed from CSV
            attachFirestoreListeners();
          } else {
            console.log("User is not signed in.");
            state.isLoading = false;
            render();
          }
        });
      }
      initialize();
    </script>
  </body>
</html>
